# Add drivers to our yocto image
+ With the example of a wifi dongle [TP-Link TL-WN725N](https://www.amazon.com/dp/B008IFXQFU)
    - Since the STM32MP157D-DK1 has no wireless support out of the box

## Kernel configuration file
+ Whenever you do a build with yocto/bitbake, bitbake will create a file where all kernel konfigurations are stored. This file is located within the `/path/to/yocto_ws/build_kirkstone/tmp/` folder, so you just need to search for it within that folder
    - Searching: `$ cd /path/to/yocto_ws/build_kirkstone/tmp/ && find . -type f -name ".config"`
        * We are looking for the `<machinename>-poky-linux-gnueabi/linux-stm32mp/<kernelversion>/build/.config` file! Be careful: u-boot has also a `.config` file within the bitbake build folder
    - Commonly this is downloaded or generated by bitbake
    - ***CAUTION***: Keep in mind that we should not change this `.config` file, since it is only defined for the local build. Also, bitbake provides an interactive `menuconfig` for doing such configurations!
## Make locally made kernel configurations a part of a custom layer
+ Do a kernel configuration by `$ bitbake -c menuconfig <domain>`, where `<domain>` is in our case `virtual/kernel`
	- Main kernel configurations:
		* Enable cfg80211 wireless extensions compatibility (wext) to enable drivers to communicate with older hardware
	- Minstres must be enables: This is the functionallity behind rate control in WIFI 802.11 (See https://inet.omnetpp.org/docs/showcases/wireless/ratecontrol/doc/index.html for details)
	- Disable the default `rtlwifi family` (Default Realtek devices), because we do not want to conflict any driver out of this conclumeration of drivers with our specific driver that we want to choose for our wifi dongle! (This is always a good idea if you want to enable specific hardware for your board, where you concretely know what hardware you want to use!) --> This avoids blacklisting drivers like in the early times of the raspberry pi with the wifi dongles!
	- Device drivers - usb support: Check that _Support for Host-side USB_ is enables. This makes USB ports acting as a host and therefore we can communicate to USB devices
		* Also, we want _Enable USB persist by default_ to not shutting down the communication if there is no data transferred for a wh√≠le
	- Within the _Device Drivers_ section, there is a bulletpoint called _Staging device drivers_, which contains drivers that are currently under development but might be in the normal kernel configuration in the near future. Here, the `Realtek RTL8188EU` driver can be found, which is the demanded driver for our wifi dongle
		* Under this driver, we can enable AP mode, which enables the Wifi dongle to act as an access point server (e.g. to let another device connect with your board, present it a login mask where you can hand over the wifi configuration that your board should connect to afterwards. This is common in many IOT devices)
	- To load the driver kernel module, we need to enable module signature verification (can be found at the top level of `menuconfig virtual/kernel`) and choose the sha-256 hash algorithm for checking. This is mainly needed since the kernel must access the region database of linux, which is only accessable by signed kernel modules

### Generating a `.config` file for our custom layer
+ Within the `/path/to/yocto_ws/build_kirkstone/tmp/work/stm32mp1-poky-linux-gnueabi/linux-stm32mp/5.15.67-stm32mp-r2-r0/build/` folder (where the above mentioned kernel configuration files `.config` are stored) are three `.config`, `.config.old` and `.config.orig` files:
	- `.config`: This is the current kernel configuration
	- `.config.old`: This is the previous kernel configuration
	- `.config.orig`: This is the kernel configuration of the first working build
+ Tipp: If you want to check if a kernel module is active within the `.config` file (and therefore in the kernel that is build with it), just cat and grep for it
	- `$ cat /path/to/yocto_ws/build_kirkstone/tmp/work/stm32mp1-poky-linux-gnueabi/linux-stm32mp/5.15.67-stm32mp-r2-r0/build/.config | grep <modulename>`
+ After doing the kernel configuration with `$ bitbake -c menuconfig virtual/kernel`, the `.config` file is locally stored within the `tmp` folder within the aforementioned path. These changes are only locally to the build folder. After deleting the build folder (which is not a good idea since the initial build takes a very long time), all configurations will be gone.
+ ***Generate a permanent `.config` change within a custom layer***:
	- Save the kernel configuration by `$ bitbake -c savedefconfig virtual/kernel`
	- After the program finished its execution, the path to the saved `defconfig` file will be printed on screen

### Adding the `defconfig` to the layer
+ First, we need to copy the `defconfig` from the `tmp` folder that the bitbake output displayed on screen to the custom layer into `/path/to/yocto_ws/meta-custom-jens/recipes-kernel/linux/files/defconfig`
	- ***CAUTION***: The file *must* be named `defconfig`. You should NOT rename it!
+ Then:
```
$ vim linux-stm32mp_%.bbappend 
FILESEXTRAPATHS:prepend := "${THISDIR}:${THISDIR}/files:"

# Update the device tree
SRC_URI:append = " file://0023-add-i2c5-userspace-dts.patch"

# Apply the default configuration from the defconfig file (out of meunconfig)
KERNEL_DEFCONFIG_stm32mp1 = "defconfig"
```
	- This applies the defconfig to the kernel, if this recipe is invoked by bitbake

### Adding the needed software packages for the functionallity to the image recipe under `recipes-core/images/custom-image.bb`
+ In out case, we need the following:
```
# Tell the image to install the WIFI driver
INSTALL_IMAGE:append = " kernel-module-r8188eu \
			linux-firmware-rtl8188 \
			dhcp-client \
			iw \
			wpa-supplicant \
			wireless-regdb-static \			
			"
``` 
	- ***CAUTION***: Make sure you have only one variable assigment statement per recipe. I experienced problems with having two `INSTALL_IMAGE:append` statements in my recipe
+ If you want to check if a new package is installed into your image, check the `<imagename>.manifest` name like this:
	- `$ cat /path/to/yocto_ws/build_kirkstone/tmp/deploy/images/stm32mp1/<imagename>.manifest| grep <packagename>`
+ ***CAUTION***: Autoloading the kernel module for the USB WIFI driver can *NOT* be done from the image recipe (even if the youtube tutorial says that it works)!
	- See https://unix.stackexchange.com/questions/308811/how-to-autoload-a-kernel-module-in-yocto for details
	- Add the following lines e.g. to your meta-kernel recipe where you also added the defconfig file:
```
# Autoload the wifi driver (no need to modprobe or insmod)
KERNEL_MODULE_AUTOLOAD:append = " r8188eu"
```

### Recommended procedure
+ Make changes via `$ bitbake -c menuconfig virtual/kernel`, building, test it until you have the functionallity you want and then save the configuration

## Working with the linux wifi tools (`$ iw` command)
+ `$ ifconfig -a`: Show all (also the currently not activated) networking interfaces
	- This should bring up all available networking interfaces on your device, while `$ ifconfig` or `$ ip addr` only shows the currently activated ones
+ `$ ifconfig <name_device> up`: Starting inactive networking devices
+ `$ iw <name_device> scan`: Shows all available networks that you can access with the device
+ Storeing your network configurations to your device:
	- The networking credentials can be found under `$ cat /etc/wpa_supplicant.conf`
	- Adding your credentials to the configuration file without doing it in plain text, you can use the `$ wpa_passphrase "<SSID>" "<password>" >> /etc/wpa_supplicant.conf` (`>>` appends to the file)
		* Make sure you delete the outcommented line with your password in cleartext from the `wpa_supplicant.conf` file!
		* `wpa_passphrase` generates a password hash for your password in cleartext so you do not need to have your password stored in cleartext
+ Starting up your network interface with the inserted credentials:
	- Use `$ wpa_supplicant -B -i wlan0 -D wext -c /etc/wpa_supplicant.conf`
		* `-B`: background mode
		* `-i`: networking interface
		* `-D`: driver to use
		* `-c`: configuration file to use
+ `$ dhcpclient <interface_name>`: Invoke this program to get an IP-address from your networking router if it works with dhcp
	- Check if your networking interface has an IP-address with `$ ifconfig` afterwards
+ `$ iw dev <network_interface> link`: Shows information about your currently connected connection
+ `$ rfkill list`: Show all interfaces and their current state
+ More information can be found here: https://www.linuxbabe.com/command-line/ubuntu-server-16-04-wifi-wpa-supplicant

## Make the WLAN dongle working
+ Check if the wlan dongle is found (USB autoconnect --> Driver gets loaded automatically)
	- `$ ifconfig -a`: The `-a` shows all networking interfaces
	- If you are not sure if the dongle driver is properly installed, ls the following:
		* `$ ls /lib/modules/5.15.67/kernel/drivers/staging/` is there is a subfolder with your drivers name, the driver was successfully installed by yocto/bitbake
+ Append your WLAN credentials to your `/etc/wpa_supplicant.conf`
	- `$ wpa_passphrase "mySSID" "myPassword" >> /etc/wpa_supplicant.conf`
+ Run the the wpa_supplicant tool to startup the device with the newly set `wpa_supplicant.conf` (with your WLAN credentials)
	- `$ wpa_supplicant -B -i wlan0, -D wext -c /etc/wpa_supplicant.conf`
+ Get your DHCP IP-address from the router/DHCP server
	- `$ udhcpc -i wlan0`
